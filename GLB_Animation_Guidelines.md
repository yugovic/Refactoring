# GLB/GLTFファイルのアニメーション制作ガイドライン

## 概要
GLB（GLTFのバイナリ版）ファイルは、3Dモデル、テクスチャ、マテリアル、アニメーションを単一ファイルに格納できる効率的なフォーマットです。本ガイドでは、アニメーション付きGLBファイルの制作要件とベストプラクティスを解説します。

## 1. GLBファイルにアニメーションを含める方法

### アニメーションの基本構造
GLTFでは、アニメーションは以下の要素で構成されます：
- **Animations配列**: すべてのアニメーションクリップを格納
- **Channels**: アニメーションの対象（ノード）と変換タイプを定義
- **Samplers**: キーフレームデータと補間方法を指定

### 複数アニメーションの格納
- 1つのGLBファイルに複数のアニメーションクリップ（歩行、走行、待機など）を含めることが可能
- 各アニメーションは独立したクリップとして管理される
- Babylon.jsでは「Animation Groups」として扱われる

## 2. アニメーションの命名規則とベストプラクティス

### 命名規則
- **一意性の確保**: 同じ名前のアニメーションがあると、多くのビューアで問題が発生
- **記述的な名前**: "attack", "run", "idle", "walk"など、動作を明確に表す名前を使用
- **一貫性**: プロジェクト全体で統一された命名パターンを維持
- **小文字推奨**: 互換性のため、小文字での命名を推奨
- **数字の回避**: エクスポートエラーを防ぐため、名前に数字を含めない

### 推奨される命名例
```
character_walk
character_run
character_idle
character_jump
character_attack_01
vehicle_drive_forward
vehicle_turn_left
```

## 3. ファイルサイズへの影響と最適化方法

### 静的GLB vs アニメーション付きGLB
- アニメーション付きGLBは静的なものより大幅にファイルサイズが増加
- モーフターゲットを使用した場合、ファイルサイズの98%がアニメーションデータになることも

### 最適化テクニック

#### 3.1 キーフレームの最適化
- 不要なキーフレームを削除
- フレームレートを適切に設定（60fps → 30fpsで約50%削減）
- 実際に変化するチャンネルのみキーフレームを設定

#### 3.2 補間方法の選択
- **STEP**: 離散的な変化に使用（最小ファイルサイズ）
- **LINEAR**: スムーズな遷移に使用（バランスが良い）
- **CUBICSPLINE**: 滑らかな接線制御が必要な場合のみ（最大ファイルサイズ）

#### 3.3 圧縮技術
- **Draco圧縮**: メッシュデータを大幅に圧縮（ただし静的ジオメトリのみ）
- **テクスチャ最適化**: 512x512または1024x1024に制限
- **ポリゴン削減**: デシメーション技術で視覚品質を保ちながらポリゴン数を削減

## 4. 複数アニメーションの格納方法

### アニメーションクリップの組織化
```javascript
{
  "animations": [
    {
      "name": "character_walk",
      "channels": [...],
      "samplers": [...]
    },
    {
      "name": "character_run",
      "channels": [...],
      "samplers": [...]
    }
  ]
}
```

### 各アニメーションの独立性
- 各アニメーションは独立したタイムラインを持つ
- 同時に複数のアニメーションを再生することも可能
- アニメーション間でのブレンディングは実装側で処理

## 5. Babylon.jsでの読み込み時の注意点

### デフォルトの挙動
- デフォルトでは最初のアニメーションが自動再生される
- 明示的に指定しない限り、他のアニメーションは再生されない

### アニメーションの制御
```javascript
// 特定のアニメーショングループを再生
const animationGroup = scene.animationGroups.find(ag => ag.name === "character_walk");
animationGroup.start();

// すべてのアニメーションを同時に再生
scene.animationGroups.forEach(ag => ag.start());
```

### パフォーマンス考慮事項
- アニメーション付きモデルのロード時間は静的モデルより長い
- モバイルデバイスでは10秒以内のロードを目標とする
- 良く最適化されたGLBは60fps、最適化されていないものは15fpsで動作する可能性

## 6. 3Dソフトウェア別のエクスポート設定

### Blender（推奨）

#### 基本ワークフロー
1. タイムラインでアニメーションを作成
2. Dope Sheet → Action Editorで名前を付ける
3. "Push Down"または"Stash"でNLAエディタに送る
4. NLAトラック名をアクション名と完全一致させる
5. すべてのNLAトラックの星マークを外す

#### エクスポート設定
- ファイル形式：GLB Binary
- アニメーション：含める
- サンプリング：アニメーションをベイク
- 最適化：アニメーションをサンプリング

#### 注意事項
- コンストレイントがある場合は、NLAに送る前にベイク
- ドリブンパラメータは手動でキーフレーム化
- Action Blendingモードは"Replace"に設定

### 3ds Max

#### プラグインオプション
1. **Babylon.js Exporter**（推奨）
2. **Alin GLTF/GLB Exporter**
3. **SimLab GLTF Exporter**

#### エクスポート設定
- 単位設定：GLTFはメートル単位（3ds Maxのシステム単位を確認）
- マテリアル：glTF Material（3ds Max 2023以降）を使用
- アニメーション：ボーン/スキンアニメーションをサポート

### Maya

#### 現状と制限
- ネイティブGLTFエクスポートはサポートされていない
- Babylon.js Exporterプラグインを使用

#### 複雑なリグの対処法
1. ジョイント階層をベイク
2. FBXとしてエクスポート
3. 新しいシーンにインポート
4. Babylonプラグインでglb/GLTF形式としてエクスポート

## 7. アニメーションのデータ構造

### キーフレームデータ
```javascript
{
  "accessors": [
    {
      // 時間データ（秒単位の浮動小数点配列）
      "bufferView": 0,
      "componentType": 5126, // FLOAT
      "count": 100,
      "type": "SCALAR"
    },
    {
      // 位置/回転/スケールデータ
      "bufferView": 1,
      "componentType": 5126,
      "count": 100,
      "type": "VEC3" // または "VEC4"（クォータニオン）
    }
  ]
}
```

### 補間方法の詳細
- **STEP**: キーフレーム間でジャンプ（補間なし）
- **LINEAR**: 線形補間（lerp）
- **CUBICSPLINE**: 3次スプライン補間（接線データ含む）

## 8. 静的GLBファイルとの違い

### ファイル構造の違い
- **静的GLB**: メッシュ、テクスチャ、マテリアルのみ
- **アニメーション付きGLB**: 上記に加えて、アニメーションデータ、キーフレーム、補間情報

### パフォーマンスへの影響
- メモリ使用量：アニメーションデータ分増加
- CPU負荷：補間計算とマトリックス更新
- GPU負荷：スキニング計算（スケルタルアニメーションの場合）

## 制作フローチェックリスト

### 事前準備
- [ ] アニメーションの種類と数を決定
- [ ] 命名規則を統一
- [ ] ターゲットプラットフォームの性能を考慮
- [ ] ファイルサイズの上限を設定

### 制作段階
- [ ] 各アニメーションを個別のアクションとして作成
- [ ] 適切な補間方法を選択
- [ ] 不要なキーフレームを削除
- [ ] フレームレートを最適化

### エクスポート前
- [ ] すべてのアニメーション名が一意であることを確認
- [ ] NLAトラック名とアクション名の一致を確認（Blender）
- [ ] コンストレイントやドリブンキーをベイク
- [ ] 単位設定を確認

### エクスポート後
- [ ] Babylon.js Sandboxでプレビュー
- [ ] すべてのアニメーションが正しく再生されることを確認
- [ ] ファイルサイズが許容範囲内であることを確認
- [ ] ターゲットデバイスでのパフォーマンステスト

## まとめ

アニメーション付きGLBファイルの制作は、適切な計画と最適化により、効率的で高品質な3Dコンテンツを実現できます。本ガイドラインに従うことで、Babylon.jsをはじめとする様々なプラットフォームで安定して動作するアニメーションアセットを制作できます。

重要なポイント：
- 一意で記述的なアニメーション名を使用
- 適切な補間方法とフレームレートの選択
- エクスポート前の十分なテストとベイク処理
- ファイルサイズとパフォーマンスのバランス